<!DOCTYPE html>
<html>

<head>
    <title>FHIR Package Graph</title>
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        #network {
            width: 100%;
            height: 800px;
            border: 1px solid lightgray;
        }

        #controls {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <h1 style="text-align: center; margin-top: 20px;margin-bottom: 0px;">FHIR Package Dependency Graph</h1>
    <p style="text-align: center; margin-bottom: 10px; font-size: 1em; color: gray;">
        Explore transitive dependencies across FHIR packages. <br>
        Data Retrieved from <a
            href="https://fhir.org/guides/stats2/registry.json">https://fhir.org/guides/stats2/registry.json</a> every
        day.
    </p>
    <div id="controls">

        <label for="packageSelect">Package:</label>
        <select id="packageSelect" style="width: 300px;"></select>

        <label for="versionSelect">Version:</label>
        <select id="versionSelect" style="width: 150px;"></select>



        <label for="direction">Direction:</label>
        <select id="direction">
            <option value="both">Both</option>
            <option value="has">Has Dependency</option>
            <option value="is">Is Dependency</option>
        </select>
        <button onclick="render()">Render</button>
    </div>
    <div style="margin-top: 10px; font-size: 0.9em;">
        <span style="color: blue;">has dependency</span> &nbsp;
        <span style="color: green;">is a dependency of</span>
    </div>
    
<div id="main-container" style="display: flex; width: 100%; height: 800px;">
  <div id="graph-container" style="flex: 1; position: relative;">
    <div id="network" style="width: 100%; height: 100%; border: 1px solid lightgray;"></div>

    <!-- üü¶ Toggle button stays aligned on graph side -->
    <button id="toggleSidebarBtn"
      onclick="toggleSidebar()"
        title="Show or hide the package list"

      style="
        position: absolute;
        top: 20px;
        right: 0;
        transform: translateX(50%);
        z-index: 999;
        padding: 5px 10px;
        border-radius: 0 4px 4px 0;
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;">
      ‚ñ∂
    </button>
  </div>

  <div id="sidebar" style="width: 300px; display: none; flex-direction: column; border-left: 1px solid #ccc;">
    <div style="padding: 10px;">
      <h3>Packages in Graph</h3>
      <ul id="nodeNames" style="font-size: 0.9em;"></ul>
    </div>
  </div>
</div>

    <div id="footer" style="margin-top: 20px; font-size: 0.9em; color: gray; text-align: center;"></div>

    <script>
        let rawData = {};
        let nodes = [];
        let edges = [];

        let packageMap = {};  // e.g., { "hl7.fhir.us.core": [ "6.1.0", "5.0.1", ... ] }
        let allPackageNames = [];


        async function fetchData() {
            const res = await fetch("slim_fhir_graph.json");
            const data = await res.json();
            rawData = data.packages;

            // If using Option A structure:
            const created = data.created || "unknown date";
            rawData = data.packages;

            // Show in footer
            document.getElementById("footer").textContent = `Data generated on: ${new Date(created).toLocaleString()}`;


            // Build map of package name ‚Üí versions
            rawData.forEach(pkg => {
                if (!packageMap[pkg.name]) {
                    packageMap[pkg.name] = [];
                    allPackageNames.push(pkg.name);
                }
                packageMap[pkg.name].push(pkg.version);
            });

            const select2Data = [{ id: '', text: '' }, ...allPackageNames.map(name => ({ id: name, text: name }))];

            $('#packageSelect').select2({
                data: select2Data,
                placeholder: "Select a package",
                allowClear: true
            });


            $('#versionSelect').select2({
                placeholder: "Select version",
                allowClear: true
            });

            // Update versions when a package is selected
            $('#packageSelect').on('change', function () {
                const selectedName = $(this).val();
                updateVersionDropdown(selectedName);
            });

            // Optional: auto-render on version change
            $('#versionSelect').on('change', function () {
                const name = $('#packageSelect').val();
                const version = $(this).val();
                if (name && version);
            });
        }


        function buildGraph(selectedId, direction) {
            nodes = [];
            edges = [];
            const seen = new Set();

            const rootPkg = rawData.find(pkg => pkg.id === selectedId);
            if (!rootPkg) return;

            // Add root node with highlight
            nodes.push({
                id: rootPkg.id,
                label: rootPkg.id,
                color: { background: "orange", border: "black" },
                font: { color: "black", bold: true }
            });
            seen.add(rootPkg.id);

            if (direction === "has" || direction === "both") {
                const stack = [rootPkg];

                while (stack.length > 0) {
                    const current = stack.pop();

                    for (const depId of current.dependencies) {
                        // Avoid duplicates
                        if (!seen.has(depId)) {
                            nodes.push({ id: depId, label: depId });
                            seen.add(depId);
                            const depPkg = rawData.find(pkg => pkg.id === depId);
                            if (depPkg) stack.push(depPkg); // Push for further traversal
                        }

                        // Add edge
                        edges.push({
                            from: current.id,
                            to: depId,
                            color: "blue",
                            arrows: "to"
                        });
                    }
                }
            }

            if (direction === "is" || direction === "both") {
                for (const pkg of rawData) {
                    if (pkg.dependencies.includes(rootPkg.id)) {
                        if (!seen.has(pkg.id)) {
                            nodes.push({ id: pkg.id, label: pkg.id });
                            seen.add(pkg.id);
                        }

                        edges.push({
                            from: pkg.id,
                            to: rootPkg.id,
                            color: "green",
                            arrows: "from"
                        });
                    }
                }
            }
        }

        function render() {
            const name = document.getElementById("packageSelect").value;
            const version = document.getElementById("versionSelect").value;
            const direction = document.getElementById("direction").value;

            if (!name || !version) return;

            const fullId = `${name}#${version}`;
            buildGraph(fullId, direction);

             // üëâ Populate the sidebar list
  const ul = document.getElementById("nodeNames");
  ul.innerHTML = "";

  nodes.sort((a, b) => a.label.localeCompare(b.label)).forEach(node => {
    const li = document.createElement("li");
    li.textContent = node.label;
    ul.appendChild(li);
  });
            const container = document.getElementById("network");
            const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
            const options = {
                nodes: { shape: "dot", size: 12 },
                edges: { arrows: "to" },
                physics: {
                    stabilization: false, enabled: true,
                    solver: "repulsion",
                    repulsion: {
                        nodeDistance: 100,  // ‚¨ÖÔ∏è Increase for more spacing
                        centralGravity: 0.2,
                        springLength: 150,
                        springConstant: 0.02,
                        damping: 0.09
                    }
                },
                layout: {
                    improvedLayout: true
                }
            };




            new vis.Network(container, data, options);
        }

        fetchData();

let sidebarVisible = false;

function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const graphContainer = document.getElementById("graph-container");
  const toggleBtn = document.getElementById("toggleSidebarBtn");

  if (sidebarVisible) {
    sidebar.style.display = "none";
    graphContainer.style.flex = "1 1 100%";
    toggleBtn.textContent = "‚ñ∂"; // collapsed
  } else {
    sidebar.style.display = "flex";
    graphContainer.style.flex = "1";
    toggleBtn.textContent = "‚óÄ"; // expanded
  }

  sidebarVisible = !sidebarVisible;
}


        function updateVersionDropdown(name) {
            const versions = (packageMap[name] || []).sort().reverse();

            const $versionSelect = $('#versionSelect');
            $versionSelect.empty();
            $versionSelect.append('<option></option>'); // placeholder

            versions.forEach(ver => {
                $versionSelect.append(new Option(ver, ver));
            });

            $versionSelect.trigger('change.select2');

            if (versions.length === 1) {
                $versionSelect.val(versions[0]).trigger('change');
            }
        }
    </script>
</body>

</html>